package com.ringtaillemur.analyst.query;

//test 4
public class OlapQuery {
	public static final String MAKE_LEAD_TIME_FOR_CHANGE
		=
		"INSERT INTO lead_time_for_change\n"
			+ "(pull_request_id, first_commit_time, pr_open_time, first_review_time, pr_close_time, repository_id)\n"
			+ "SELECT target_pr.pr_id           AS pull_request_id,\n"
			+ "       isnull(commits.first_commit_time, pre.event_time) AS first_commit_time,\n"
			+ "       pre.event_time            AS pr_open_time,\n"
			+ "       isnull(review.first_review_time, pr_close_time)  AS first_review_time,\n"
			+ "       target_pr.pr_close_time   AS pr_close_time,\n"
			+ "       target_pr.repo_id         as repository_id\n"
			+ "FROM (SELECT pr.pull_request_id  AS pr_id,\n"
			+ "             pr_event.event_time AS pr_close_time,\n"
			+ "             pr.repository_id    as repo_id\n"
			+ "      FROM pull_request_event pr_event\n"
			+ "               JOIN pull_request pr\n"
			+ "                    ON pr_event.pull_request_id = pr.pull_request_id\n"
			+ "               LEFT JOIN\n"
			+ "           pr_direction_source_count pr_source\n"
			+ "           ON pr_source.pr_id = pr.pull_request_id\n"
			+ "      WHERE pr_event.pull_request_event_type = 'CLOSED'\n"
			+ "        AND pr.lead_time_for_change_process_end = 0\n"
			+ "        AND pr_source.source_count IS NULL) target_pr\n"
			+ "         LEFT JOIN\n"
			+ "     pr_first_review_times review\n"
			+ "     ON target_pr.pr_id = review.pr_id\n"
			+ "         LEFT JOIN\n"
			+ "     pr_first_commit_times commits\n"
			+ "     ON target_pr.pr_id = commits.pr_id\n"
			+ "         JOIN\n"
			+ "     pull_request_event pre\n"
			+ "     ON pre.pull_request_id = target_pr.pr_id and pre.pull_request_event_type = 'OPENED';\n"
			+ "\n"
			+ "\n"
			+ "BEGIN TRAN\n"
			+ "\n"
			+ "\n"
			+ "UPDATE pull_request\n"
			+ "set lead_time_for_change_process_end = 1\n"
			+ "FROM pull_request join pull_request_event on pull_request.pull_request_id = pull_request_event.pull_request_id\n"
			+ "where pull_request.lead_time_for_change_process_end = 0\n"
			+ "    AND pull_request_event.pull_request_event_type = 'CLOSED'\n"
			+ "\n"
			+ "COMMIT TRAN";
	public static final String MAKE_DEPLOY_TIME
		=
		"UPDATE lead_time_for_change\n"
			+ "\t\t\tSET lead_time_for_change.deployment_time =deployment_time.et,\n"
			+ "\t\t\t\tlead_time_for_change.release_id      =deployment_time.ri\n"
			+ "\t\t\tFROM lead_time_for_change,\n"
			+ "\t\t\t\t(select distinct\n"
			+ "\t\t\t\t\tcommits_first_pr.first_pr_id \t\t\t\tpr_id,\n"
			+ "\t\t\t\t\tcommits_not_calculated_ltfc.published_at \tet,\n"
			+ "\t\t\t\t\tcommits_not_calculated_ltfc.release_id \t\tri\n"
			+ "\t\t\t\tfrom commits_first_pr\n"
			+ "\t\t\t\t\tJOIN commits_not_calculated_ltfc*\n"
			+ "\t\t\t\t\t\tON commits_first_pr.commit_id =commits_not_calculated_ltfc.commit_id\n"
			+ "\t\t\t\tWHERE commits_not_calculated_ltfc.lead_time_for_change_process_end =0) AS deployment_time\n"
			+ "\t\t\twhere deployment_time.pr_id =lead_time_for_change.pull_request_id\n"
			+ "\t\t\t\t\t\t\n"
			+ "\t\t\tUPDATE release\t\n"
			+ "\t\t\tSET lead_time_for_change_process_end = 1\n"
			+ "\t\t\twhere lead_time_for_change_process_end =0;";
	public static final String MAKE_CHANGE_FAILURE_RATE
		= "BEGIN TRAN\n"
		+ "\t\t\t   \n"
		+ "\t\t\tINSERT INTO release_success(release_id, repository_id, released_at)\n"
		+ "\t\t\tSELECT release_id, release.repository_id, release.published_at\n"
		+ "\t\t\tFROM release\n"
		+ "\t\t\tWHERE change_failure_rate_process_end = 0;\n"
		+ "\t\t\t   \n"
		+ "\t\t\tUPDATE release\n"
		+ "\t\t\tSET change_failure_rate_process_end = 1\n"
		+ "\t\t\tWHERE change_failure_rate_process_end = 0;\n"
		+ "\t\t\t   \n"
		+ "\t\t\tCOMMIT TRAN\n"
		+ "\t\t\t   \n"
		+ "\t\t\t   \n"
		+ "\t\t\tBEGIN TRAN\n"
		+ "\t\t\t   \n"
		+ "\t\t\tUPDATE release_success\n"
		+ "\t\t\tSET release_success.failed_at = ie.event_time,\n"
		+ "\t\t\t    first_error_issue_id      = ie.issue_id,\n"
		+ "\t\t\t    release_success.is_success= 0\n"
		+ "\t\t\tFROM release_success\n"
		+ "\t\t\t         JOIN run_time_error_labels il ON release_success.repository_id = il.repository_id\n"
		+ "\t\t\t         JOIN release on il.release_name = release.name\n"
		+ "\t\t\t         JOIN issue i ON i.issue_label_id = il.issue_label_id\n"
		+ "\t\t\t         JOIN issue_event ie ON ie.issue_id = i.issue_id\n"
		+ "\t\t\tWHERE release_success.is_success = 1\n"
		+ "\t\t\t  AND i.failed_change_process_end = 0\n"
		+ "\t\t\t  AND ie.issue_event_type = 'OPENED'\n"
		+ "\t\t\t   \n"
		+ "\t\t\tUPDATE issue\n"
		+ "\t\t\tset failed_change_process_end = 1\n"
		+ "\t\t\tFROM issue i\n"
		+ "\t\t\t         JOIN issue_event ie ON ie.issue_id = i.issue_id\n"
		+ "\t\t\twhere failed_change_process_end = 0 AND ie.issue_event_type = 'OPENED'\n"
		+ "\t\t\t   \n"
		+ "\t\t\tCOMMIT TRAN";
	public static final String MAKE_TIME_TO_RESTORE_SERVICE
		= "BEGIN TRAN\n"
		+ "\t\t\t   \n"
		+ "\t\t\tINSERT\n"
		+ "\t\t\tINTO time_to_restore_service (release_success_id, restore_service_time, restored_at, repository_id)\n"
		+ "\t\t\tSELECT closed_issue.release_success_id,\n"
		+ "\t\t\t       DATEDIFF(minute, opened_issue.opened_issue_event_time,\n"
		+ "\t\t\t                closed_issue.closed_issue_event_time) as restore_service_time,\n"
		+ "\t\t\t       closed_issue.closed_issue_event_time,\n"
		+ "\t\t\t       opened_issue.repository_id\n"
		+ "\t\t\tFROM closed_issue\n"
		+ "\t\t\t         join opened_issue\n"
		+ "\t\t\t              on closed_issue.release_success_id = opened_issue.release_success_id\n"
		+ "\t\t\tWHERE time_to_restore_service_process_end = 0;\n"
		+ "\t\t\t   \n"
		+ "\t\t\tCOMMIT TRAN\n"
		+ "\t\t\t   \n"
		+ "\t\t\tBEGIN TRAN\n"
		+ "\t\t\t   \n"
		+ "\t\t\tUPDATE release_success\n"
		+ "\t\t\tSET release_success.time_to_restore_service_process_end = 1\n"
		+ "\t\t\tFROM issue_event\n"
		+ "\t\t\t         JOIN release_success ON release_success.first_error_issue_id = issue_event.issue_id\n"
		+ "\t\t\tWHERE time_to_restore_service_process_end = 0\n"
		+ "\t\t\t  AND issue_event_type = 'CLOSED'\n"
		+ "\t\t\t   \n"
		+ "\t\t\tCOMMIT TRAN";
	public static String PUBLISHED_AND_NOT_CALCULATE_LEAD_TIME_FOR_CHANGE_RELEASE
		= "SELECT release.repository_id as\n"
		+ "\t\t\t           repository_id,\n"
		+ "\t\t\t       release.tag_name      as\n"
		+ "\t\t\t           tag_name,\n"
		+ "\t\t\t       repository_name,\n"
		+ "\t\t\t       owner_name,\n"
		+ "\t\t\t       release.release_id\n"
		+ "\t\t\tFROM release\n"
		+ "\t\t\t         JOIN repository_owner_table\n"
		+ "\t\t\t              on repository_owner_table.repository_id = release.repository_id\n"
//		+ "\t\t\t         JOIN release_event\n"
//		+ "\t\t\t              ON release.release_id = release_event.release_id\n"
//		+ "\t\t\t                  AND release_event.release_event_type = 'PUBLISHED'\n"
		+ "\t\t\t         JOIN repository\n"
		+ "\t\t\t              ON release.repository_id = repository.repository_id\n"
		+ "\t\t\tWHERE release.lead_time_for_change_process_end = 0\n"
		+ "\t\t\tORDER BY release.repository_id, release.published_at;";
	public static String PUBLISHED_AND_CALCULATED_LEAD_TIME_FOR_CHANGE_RELEASE
		= "SELECT TOP 1 release.repository_id,\n"
		+ "\t\t\t             release.tag_name,\n"
		+ "\t\t\t             repository_name,\n"
		+ "\t\t\t             owner_name,\n"
		+ "\t\t\t             release.release_id\n"
		+ "\t\t\tFROM release\n"
		+ "\t\t\t         JOIN repository_owner_table\n"
		+ "\t\t\t              on repository_owner_table.repository_id = release.repository_id\n"
//		+ "\t\t\t         JOIN release_event\n"
//		+ "\t\t\t              ON release.release_id = release_event.release_id\n"
//		+ "\t\t\t                  AND release_event.release_event_type = 'PUBLISHED'\n"
		+ "\t\t\t         JOIN repository\n"
		+ "\t\t\t              ON release.repository_id = repository.repository_id\n"
		+ "\t\t\tWHERE release.lead_time_for_change_process_end = 1\n"
		+ "\t\t\tORDER BY release.published_at;";
	public static String UPDATE_COMMITS_RELEASE_ID
		= "MERGE commits\n"
		+ "USING(VALUES %s) as pairs(sha,changed_release_id)\n"
		+ "\ton commit_id = sha\n"
		+ "WHEN MATCHED\n"
		+ "THEN UPDATE\n"
		+ "SET release_id = changed_release_id;";
}
