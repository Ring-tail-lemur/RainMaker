<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.5.0/Chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<link rel = "stylesheet" href="graph.css">


<body>

    시작시간(EX.2022-08-01) <input id="start_time" onchange="chartChange()"><br>
    끝시간(EX.2022-08-01) <input id="end_time" onchange="chartChange()"><br>
    리포지토리 토큰 <input id="repo" onchange="chartChange()"><br>

    <div id="mainArea">
        <canvas id="LeadTimeForChange" style="width:100%;max-width:600px"></canvas>
        <canvas id="DeploymentFrequency" style="width:100%;max-width:600px"></canvas>
        <canvas id="ChangeFailureRate" style="width:100%;max-width:600px"></canvas>
        <canvas id="MTTR" style="width:100%;max-width:600px"></canvas>
    </div>


    <script>
        

        function initChart(chartname, xValues, yValues, barColors) {
            console.log("chartName ==== ", chartname)
            
            new Chart(chartname, {
            type: "bar",
            data: {
                labels: xValues,
                datasets: [{
                backgroundColor: barColors,
                data: yValues
                }]
            },
            options: {
                scales : {
                    y: {
                        beginAtZero: true
                    },
                    yAxes: 
                    [{
                            ticks: {
                                min: 0,
                                // fontSize : 14,
                            }
                    }]
                },
                legend: {display: false},
                title: {
                display: true,
                text: chartname
                }
                
            }
            });
        }(
            "LeadTimeForChange",
            ["1week", "2week", "3week", "4week", "5week"],
            [55, 49, 44, 24, 30],
            ["red", "green","blue","orange","brown"]
        );


        async function chartChange(){

            
            



            const start_time = document.getElementById('start_time').value;
            const end_time = document.getElementById('end_time').value;
            const repo = document.getElementById('repo').value;
            
            console.log("Day, repo : ", start_time, end_time, repo);    
            if(!start_time || !end_time) return;

            console.log("Day, repo : ", start_time, end_time, repo);

            
            const Message = await axios.get('http://localhost:8080/frontfor/cycletime', {
                params : {
                    start_time : start_time,
                    end_time : end_time,
                    repo : repo
                }
            })

            // const Message = await axios({
            //     method: 'get',
            //     url: 'http://localhost:8080/frontfor/cycletime',
            //     data : {

            //     },
            //     responseType: 'stream'
            // });


            console.log("================================== \n", Message.data);
            console.log("================================== \n", Message.data.leadTimeForChangeAverageMap);
            let info = Message.data.leadTimeForChangeAverageMap;
            
            

            const sort = Object.entries(info).sort();
            console.log("*****************", sort[0][0], sort[0][1]);
            let lead_time_for_change_arr = [];
            let date_arr = [];
            for(var i =0; i< sort.length; i++){
                lead_time_for_change_arr.push(sort[i][1]);
                date_arr.push(sort[i][0]);
            }
            
            

            testMessage = 
                [
                    {
                        start_time : Message.data.start_time,
                        end_time : Message.data.end_time,
                        level : Message.data.level,
                        lead_time_for_change : lead_time_for_change_arr
                    }
                ]
            
            // let st_date = new Date(testMessage[0].start_time);
            // const en_date = new Date(testMessage[0].end_time);
            
            // console.log("date_arr : " , st_date, en_date);
            
            // let date_arr = [];

            // while(st_date <= en_date) {
            //     console.log("st_Date : ", st_date);
            //     date_arr.push(st_date.getMonth()+1 + "." + st_date.getDate());
            //     st_date.setDate(st_date.getDate() +1);
            // }

            // const daytime = st_date.getMonth() + "-"+ st_date.getDate(); 
            
            console.log("date_arr : " , date_arr);
            

            window.onload = initChart(
                "LeadTimeForChange",
                date_arr,
                testMessage[0].lead_time_for_change,
                // ["red", "green","blue","orange","brown"],
                // "Elite",
            );

            window.onload = initChart(
                "DeploymentFrequency",
                ["1week", "2week", "3week", "4week", "5week"],
                [55, 49, 44, 24, 30],
                ["red", "green","blue","orange","brown"]
            );

            window.onload = initChart(
                "ChangeFailureRate",
                ["1week", "2week", "3week", "4week", "5week"],
                [55, 49, 44, 24, 30],
                ["red", "green","blue","orange","brown"]
            );

            window.onload = initChart(
                "MTTR",
                ["1week", "2week", "3week", "4week", "5week"],
                [55, 49, 44, 24, 30],
                ["red", "green","blue","orange","brown"]
            );
        }

    </script>
</body>

</html>